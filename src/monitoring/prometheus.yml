# Prometheus Configuration for VideoAgent Monitoring
#
# This configuration scrapes metrics from the VideoAgent API service
# and provides a foundation for monitoring and alerting.
#
# Usage:
#   docker run -d \
#     --name videoagent-prometheus \
#     -p 9090:9090 \
#     -v $(pwd)/prometheus.yml:/etc/prometheus/prometheus.yml \
#     --network nexus-network \
#     prom/prometheus

global:
  scrape_interval: 15s       # Scrape targets every 15 seconds
  evaluation_interval: 15s   # Evaluate rules every 15 seconds
  scrape_timeout: 10s        # Timeout for scrape requests

  # External labels to attach to any time series or alerts
  external_labels:
    monitor: 'videoagent'
    environment: 'production'
    cluster: 'nexus'

# Alertmanager configuration (optional - uncomment if using Alertmanager)
# alerting:
#   alertmanagers:
#     - static_configs:
#         - targets:
#           - 'localhost:9093'

# Rule files for alerting (optional - uncomment to enable)
# rule_files:
#   - '/etc/prometheus/rules/videoagent_alerts.yml'

# Scrape configurations
scrape_configs:
  # VideoAgent API metrics
  - job_name: 'videoagent-api'

    # Override global scrape interval for API
    scrape_interval: 15s
    scrape_timeout: 10s

    # Metrics endpoint
    metrics_path: '/videoagent/api/metrics'

    # Service discovery - Docker
    # If running in Docker with service discovery:
    # docker_sd_configs:
    #   - host: unix:///var/run/docker.sock
    #     filters:
    #       - name: name
    #         values:
    #           - nexus-videoagent-api

    # Static configuration (replace with actual service address)
    static_configs:
      - targets:
          - 'nexus-videoagent-api:3000'  # Docker service name
          # - 'localhost:3000'                    # Local development
        labels:
          service: 'videoagent-api'
          component: 'backend'
          tier: 'application'

    # Relabel configurations for cleaner metric labels
    relabel_configs:
      # Use instance label from target
      - source_labels: [__address__]
        target_label: instance

      # Add hostname label
      - source_labels: [__address__]
        regex: '([^:]+)(:[0-9]+)?'
        replacement: '${1}'
        target_label: hostname

    # Metric relabeling (optional - modify metrics after scraping)
    metric_relabel_configs:
      # Drop metrics we don't need (example)
      # - source_labels: [__name__]
      #   regex: 'process_.*'
      #   action: drop

  # VideoAgent Worker metrics (if worker exposes metrics)
  - job_name: 'videoagent-worker'
    scrape_interval: 15s
    scrape_timeout: 10s
    metrics_path: '/metrics'

    static_configs:
      - targets:
          - 'nexus-videoagent-worker:9100'  # Adjust port if different
        labels:
          service: 'videoagent-worker'
          component: 'processor'
          tier: 'worker'

  # MageAgent metrics (if available)
  - job_name: 'mageagent'
    scrape_interval: 15s
    scrape_timeout: 10s
    metrics_path: '/metrics'

    static_configs:
      - targets:
          - 'nexus-mageagent:5000'
        labels:
          service: 'mageagent'
          component: 'ai-service'
          tier: 'ml'

  # Redis metrics (using redis_exporter)
  # Install: docker run -d --name redis-exporter -p 9121:9121 oliver006/redis_exporter
  - job_name: 'redis'
    scrape_interval: 15s

    static_configs:
      - targets:
          - 'redis-exporter:9121'
        labels:
          service: 'redis'
          component: 'cache'
          tier: 'data'

  # Node exporter for host metrics (optional)
  # Install: docker run -d --name node-exporter -p 9100:9100 prom/node-exporter
  - job_name: 'node-exporter'
    scrape_interval: 30s

    static_configs:
      - targets:
          - 'node-exporter:9100'
        labels:
          service: 'node'
          component: 'host'
          tier: 'infrastructure'

# ============================================================================
# Advanced Configuration Examples
# ============================================================================

# Service Discovery with Kubernetes
# - job_name: 'kubernetes-pods'
#   kubernetes_sd_configs:
#     - role: pod
#   relabel_configs:
#     - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
#       action: keep
#       regex: true
#     - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
#       action: replace
#       target_label: __metrics_path__
#       regex: (.+)
#     - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
#       action: replace
#       regex: ([^:]+)(?::[0-9]+)?;([0-9]+)
#       replacement: $1:$2
#       target_label: __address__

# Remote Write (for long-term storage)
# remote_write:
#   - url: "https://prometheus-remote-storage.example.com/api/v1/write"
#     basic_auth:
#       username: "your_username"
#       password: "your_password"

# Remote Read (for querying long-term storage)
# remote_read:
#   - url: "https://prometheus-remote-storage.example.com/api/v1/read"
#     basic_auth:
#       username: "your_username"
#       password: "your_password"

# ============================================================================
# Storage Configuration (tsdb)
# ============================================================================
# Configure via command-line flags when starting Prometheus:
#   --storage.tsdb.path=/prometheus
#   --storage.tsdb.retention.time=30d
#   --storage.tsdb.retention.size=50GB
