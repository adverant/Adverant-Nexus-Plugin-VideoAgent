# Prometheus Alerting Rules for VideoAgent
#
# These rules define alerting conditions for monitoring VideoAgent health,
# performance, and reliability.
#
# To enable, uncomment the rule_files section in prometheus.yml:
#   rule_files:
#     - '/etc/prometheus/rules/videoagent_alerts.yml'

groups:
  # ============================================================================
  # High Priority - Service Availability
  # ============================================================================
  - name: videoagent_availability
    interval: 30s
    rules:
      - alert: VideoAgentAPIDown
        expr: up{job="videoagent-api"} == 0
        for: 1m
        labels:
          severity: critical
          component: api
        annotations:
          summary: "VideoAgent API is down"
          description: "VideoAgent API has been down for more than 1 minute. Instance: {{ $labels.instance }}"

      - alert: VideoAgentWorkerDown
        expr: up{job="videoagent-worker"} == 0
        for: 2m
        labels:
          severity: critical
          component: worker
        annotations:
          summary: "VideoAgent Worker is down"
          description: "VideoAgent Worker has been down for more than 2 minutes. Instance: {{ $labels.instance }}"

      - alert: MageAgentDown
        expr: up{job="mageagent"} == 0
        for: 1m
        labels:
          severity: critical
          component: mageagent
        annotations:
          summary: "MageAgent service is down"
          description: "MageAgent has been down for more than 1 minute. Instance: {{ $labels.instance }}"

  # ============================================================================
  # High Priority - Error Rates
  # ============================================================================
  - name: videoagent_errors
    interval: 30s
    rules:
      - alert: HighHTTPErrorRate
        expr: |
          (
            sum(rate(videoagent_http_requests_total{status_code=~"5.."}[5m])) by (instance)
            /
            sum(rate(videoagent_http_requests_total[5m])) by (instance)
          ) > 0.05
        for: 5m
        labels:
          severity: critical
          component: api
        annotations:
          summary: "High HTTP 5xx error rate"
          description: "HTTP 5xx error rate is {{ $value | humanizePercentage }} (threshold: 5%). Instance: {{ $labels.instance }}"

      - alert: HighVideoProcessingFailureRate
        expr: |
          (
            sum(rate(videoagent_video_processing_errors_total[5m])) by (instance)
            /
            sum(rate(videoagent_video_processing_duration_seconds_count[5m])) by (instance)
          ) > 0.10
        for: 10m
        labels:
          severity: warning
          component: processor
        annotations:
          summary: "High video processing failure rate"
          description: "Video processing failure rate is {{ $value | humanizePercentage }} (threshold: 10%). Instance: {{ $labels.instance }}"

      - alert: MageAgentCircuitBreakerOpen
        expr: videoagent_circuit_breaker_state{name="mageagent"} == 2
        for: 2m
        labels:
          severity: critical
          component: mageagent
        annotations:
          summary: "MageAgent circuit breaker is OPEN"
          description: "Circuit breaker for MageAgent has been OPEN for more than 2 minutes, indicating persistent failures. Instance: {{ $labels.instance }}"

  # ============================================================================
  # Medium Priority - Performance
  # ============================================================================
  - name: videoagent_performance
    interval: 1m
    rules:
      - alert: HighAPILatency
        expr: |
          histogram_quantile(0.95,
            sum(rate(videoagent_http_request_duration_seconds_bucket[5m])) by (le, instance)
          ) > 2
        for: 5m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "High API latency (P95)"
          description: "P95 API latency is {{ $value }}s (threshold: 2s). Instance: {{ $labels.instance }}"

      - alert: HighVideoProcessingLatency
        expr: |
          histogram_quantile(0.95,
            sum(rate(videoagent_video_processing_duration_seconds_bucket[10m])) by (le, instance)
          ) > 300
        for: 10m
        labels:
          severity: warning
          component: processor
        annotations:
          summary: "High video processing latency (P95)"
          description: "P95 video processing latency is {{ $value }}s (threshold: 300s / 5min). Instance: {{ $labels.instance }}"

      - alert: HighMageAgentLatency
        expr: |
          histogram_quantile(0.95,
            sum(rate(videoagent_mageagent_request_duration_seconds_bucket[5m])) by (le, instance)
          ) > 5
        for: 5m
        labels:
          severity: warning
          component: mageagent
        annotations:
          summary: "High MageAgent request latency (P95)"
          description: "P95 MageAgent request latency is {{ $value }}s (threshold: 5s). Instance: {{ $labels.instance }}"

  # ============================================================================
  # Medium Priority - Queue Health
  # ============================================================================
  - name: videoagent_queue_health
    interval: 1m
    rules:
      - alert: VideoQueueBacklogGrowing
        expr: |
          (
            videoagent_queue_size - videoagent_queue_size offset 5m
          ) > 50
        for: 10m
        labels:
          severity: warning
          component: queue
        annotations:
          summary: "Video processing queue backlog growing"
          description: "Queue size has increased by more than 50 jobs in the last 5 minutes. Current size: {{ $value }}. Instance: {{ $labels.instance }}"

      - alert: VideoQueueSizeHigh
        expr: videoagent_queue_size > 1000
        for: 5m
        labels:
          severity: warning
          component: queue
        annotations:
          summary: "Video processing queue size is high"
          description: "Queue size is {{ $value }} jobs (threshold: 1000). Instance: {{ $labels.instance }}"

      - alert: VideoQueueProcessingStalled
        expr: |
          rate(videoagent_queue_processing_duration_seconds_count[10m]) == 0
          and videoagent_queue_size > 0
        for: 5m
        labels:
          severity: critical
          component: queue
        annotations:
          summary: "Video processing queue is stalled"
          description: "No jobs have been processed in the last 10 minutes, but queue has {{ $value }} jobs. Instance: {{ $labels.instance }}"

  # ============================================================================
  # Medium Priority - Resource Utilization
  # ============================================================================
  - name: videoagent_resources
    interval: 1m
    rules:
      - alert: HighMemoryUsage
        expr: |
          (
            process_resident_memory_bytes{job="videoagent-api"}
            /
            (1024 * 1024 * 1024)
          ) > 4
        for: 5m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "High memory usage"
          description: "Memory usage is {{ $value }}GB (threshold: 4GB). Instance: {{ $labels.instance }}"

      - alert: HighCPUUsage
        expr: |
          rate(process_cpu_seconds_total{job="videoagent-api"}[5m]) > 0.8
        for: 5m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "High CPU usage"
          description: "CPU usage is {{ $value | humanizePercentage }} (threshold: 80%). Instance: {{ $labels.instance }}"

      - alert: HighActiveConnections
        expr: videoagent_websocket_active_connections > 1000
        for: 5m
        labels:
          severity: warning
          component: websocket
        annotations:
          summary: "High number of active WebSocket connections"
          description: "Active WebSocket connections: {{ $value }} (threshold: 1000). Instance: {{ $labels.instance }}"

  # ============================================================================
  # Low Priority - Cache Performance
  # ============================================================================
  - name: videoagent_cache
    interval: 5m
    rules:
      - alert: LowCacheHitRate
        expr: |
          (
            sum(rate(videoagent_cache_hits_total[10m])) by (instance)
            /
            (sum(rate(videoagent_cache_hits_total[10m])) by (instance) + sum(rate(videoagent_cache_misses_total[10m])) by (instance))
          ) < 0.50
        for: 15m
        labels:
          severity: info
          component: cache
        annotations:
          summary: "Low cache hit rate"
          description: "Cache hit rate is {{ $value | humanizePercentage }} (threshold: 50%). Instance: {{ $labels.instance }}"

      - alert: HighCacheEvictionRate
        expr: rate(videoagent_cache_evictions_total[5m]) > 100
        for: 10m
        labels:
          severity: info
          component: cache
        annotations:
          summary: "High cache eviction rate"
          description: "Cache eviction rate is {{ $value }} evictions/sec (threshold: 100). Instance: {{ $labels.instance }}"

  # ============================================================================
  # Low Priority - Rate Limiting
  # ============================================================================
  - name: videoagent_rate_limiting
    interval: 5m
    rules:
      - alert: HighRateLimitRejectionRate
        expr: |
          (
            sum(rate(videoagent_http_requests_total{status_code="429"}[5m])) by (instance)
            /
            sum(rate(videoagent_http_requests_total[5m])) by (instance)
          ) > 0.10
        for: 10m
        labels:
          severity: info
          component: rate-limiter
        annotations:
          summary: "High rate limit rejection rate"
          description: "Rate limit rejection rate is {{ $value | humanizePercentage }} (threshold: 10%). Consider increasing rate limits or investigating abuse. Instance: {{ $labels.instance }}"

# ============================================================================
# Alertmanager Routing Configuration Example
# ============================================================================
# Create alertmanager.yml with the following configuration:
#
# global:
#   resolve_timeout: 5m
#
# route:
#   group_by: ['alertname', 'component']
#   group_wait: 10s
#   group_interval: 10s
#   repeat_interval: 12h
#   receiver: 'default'
#   routes:
#     - match:
#         severity: critical
#       receiver: 'critical-alerts'
#       continue: true
#     - match:
#         severity: warning
#       receiver: 'warning-alerts'
#     - match:
#         severity: info
#       receiver: 'info-alerts'
#
# receivers:
#   - name: 'default'
#     slack_configs:
#       - api_url: 'YOUR_SLACK_WEBHOOK'
#         channel: '#videoagent-alerts'
#
#   - name: 'critical-alerts'
#     pagerduty_configs:
#       - service_key: 'YOUR_PAGERDUTY_KEY'
#     email_configs:
#       - to: 'oncall@example.com'
#         from: 'alerts@example.com'
#
#   - name: 'warning-alerts'
#     slack_configs:
#       - api_url: 'YOUR_SLACK_WEBHOOK'
#         channel: '#videoagent-warnings'
#
#   - name: 'info-alerts'
#     slack_configs:
#       - api_url: 'YOUR_SLACK_WEBHOOK'
#         channel: '#videoagent-info'
